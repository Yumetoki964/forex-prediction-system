#!/usr/bin/env python3
"""
Playwrightã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèªã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—
"""
import asyncio
from playwright.async_api import async_playwright
import os

async def check_application():
    async with async_playwright() as p:
        # ãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•
        browser = await p.chromium.launch(headless=False)
        context = await browser.new_context(
            viewport={'width': 1280, 'height': 800},
            locale='ja-JP'
        )
        page = await context.new_page()
        
        try:
            print("ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¢ºèªã‚’é–‹å§‹ã—ã¾ã™...")
            
            # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹
            print("\nğŸ“± ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...")
            await page.goto("http://localhost:5173", wait_until="networkidle")
            await page.wait_for_timeout(2000)
            
            # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±
            screenshot_path = "/Users/yumetokicross/Desktop/forex-prediction-system/screenshot_frontend.png"
            await page.screenshot(path=screenshot_path, full_page=True)
            print(f"âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜: {screenshot_path}")
            
            # ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç¢ºèª
            title = await page.title()
            print(f"ğŸ“„ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: {title}")
            
            # ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            content = await page.text_content("body")
            if content:
                # æœ€åˆã®200æ–‡å­—ã‚’è¡¨ç¤º
                print(f"ğŸ“ ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã®200æ–‡å­—ï¼‰:\n{content[:200]}...")
            
            # ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
            console_errors = []
            page.on("console", lambda msg: console_errors.append(msg.text) if msg.type == "error" else None)
            
            # APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
            print("\nğŸ–¥ï¸  APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...")
            await page.goto("http://localhost:8174/docs", wait_until="networkidle")
            await page.wait_for_timeout(2000)
            
            # APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
            api_screenshot_path = "/Users/yumetokicross/Desktop/forex-prediction-system/screenshot_api.png"
            await page.screenshot(path=api_screenshot_path, full_page=True)
            print(f"âœ… APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜: {api_screenshot_path}")
            
            # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if console_errors:
                print("\nâš ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼:")
                for error in console_errors[:5]:
                    print(f"  - {error}")
            else:
                print("\nâœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“")
            
            print("\nâœ¨ å‹•ä½œç¢ºèªå®Œäº†!")
            
        except Exception as e:
            print(f"\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            # ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
            error_screenshot = "/Users/yumetokicross/Desktop/forex-prediction-system/screenshot_error.png"
            await page.screenshot(path=error_screenshot)
            print(f"ğŸ“¸ ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ: {error_screenshot}")
            
        finally:
            await browser.close()

if __name__ == "__main__":
    asyncio.run(check_application())